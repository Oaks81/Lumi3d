# 2.1: Transmittance LUT Texture Resources

## Dependencies
- PlanetConfig.js ✓ (already exists)
- AltitudeZoneManager.js ✓ (already exists)
- TextureGenerator (existing)
- Backend system (existing)

## Scope
Create persistent RGBA16F textures (256×64 and 32×32) for atmospheric scattering lookup tables. Infrastructure only - no computation yet.

## Current State
- TextureGenerator can create textures for both backends
- Backend.createTexture() methods exist
- AtmosphericScatteringLUT class may have stubs

## Architecture Integration
```
Initialization:
Frontend.initialize()
  ├─> AtmosphericScatteringLUT.initialize()
  │     ├─> Backend.createTexture() for transmittance LUT
  │     └─> Backend.createTexture() for multi-scatter LUT (step 2.3)
  └─> Store reference: this.atmosphereLUT
```

## What Needs to Happen

### 1. Create AtmosphericScatteringLUT Class

Location: `js/atmosphere/AtmosphericScatteringLUT.js`

Responsibilities:
- Manage LUT texture lifecycle
- Track dirty state for regeneration
- Interface between Frontend and Backend for LUT operations

Should store:
- Texture handles from Backend
- Texture dimensions (256×64 for transmittance, 32×32 for multi-scatter)
- Dirty flags for regeneration
- Computation state

### 2. Create PlanetAtmosphereSettings Class

Location: `js/atmosphere/PlanetAtmosphereSettings.js`

Responsibilities:
- Store atmospheric parameters per planet type
- Provide presets (Earth, Mars, Venus)
- Scale parameters based on planet size

Parameters needed:
- Physical: planetRadius, atmosphereRadius
- Rayleigh: scattering coefficients (RGB), scale height
- Mie: scattering coefficient, anisotropy, scale height
- Ozone: absorption coefficients (RGB), distribution

### 3. Texture Creation via Backend

The LUT should use existing Backend texture creation:

WebGPU path:
- Format: `'rgba16float'`
- Usage: `TEXTURE_BINDING | STORAGE_BINDING`
- Size: [256, 64, 1] for transmittance

WebGL2 path:
- Internal format: `gl.RGBA16F`
- Format: `gl.RGBA`
- Type: `gl.FLOAT`
- Filtering: LINEAR, CLAMP_TO_EDGE

Don't use TextureGenerator if these are special render targets - create directly in Backend.

### 4. Integration in Frontend

In `Frontend.initialize()`:
```javascript
// After other initialization
this.atmosphereLUT = new AtmosphericScatteringLUT(this.backend);
await this.atmosphereLUT.initialize();

this.atmosphereSettings = PlanetAtmosphereSettings.createForPlanet(
    gameState.planetConfig
);
```

In `Frontend.dispose()`:
```javascript
if (this.atmosphereLUT) {
    this.atmosphereLUT.dispose();
}
```

## Files to Create

- `js/atmosphere/AtmosphericScatteringLUT.js`
- `js/atmosphere/PlanetAtmosphereSettings.js`

## Files to Modify

- `js/rendering/Frontend.js` - Add LUT initialization

## API Contract

### AtmosphericScatteringLUT
```javascript
class AtmosphericScatteringLUT {
    constructor(backend)
    
    async initialize()
    // Should: Create transmittance LUT texture via backend
    // Should: Store texture handles
    // Should: Log creation success
    
    dispose()
    // Should: Destroy textures via backend
    
    getTransmittanceLUT()
    // Should: Return texture handle for binding
}
```

### PlanetAtmosphereSettings
```javascript
class PlanetAtmosphereSettings {
    constructor(planetType = 'earth')
    
    static createForPlanet(planetConfig)
    // Should: Create settings scaled to planet size
    
    static createPreset(presetName)
    // Should: Return preset for 'earth', 'mars', 'venus'
}
```

## Technical Details

### Transmittance LUT
- Dimensions: 256×64 pixels
- Format: RGBA16F (half-float precision needed)
- Memory: ~131 KB (256 × 64 × 8 bytes)
- Persistent: Created once, reused until planet change

### UV Mapping (for reference, used in step 2.2)
```
u = cosViewZenith * 0.5 + 0.5     // [-1,1] → [0,1]
v = sqrt(h / atmosphereHeight)     // Non-linear altitude
```

## Backend-Specific Notes

### WebGPU
Use existing `WebGPUBackend.createTexture()` pattern if available, or add:
```javascript
createStorageTexture(width, height, format, label)
```

### WebGL2
Use existing `WebGL2Backend.createTexture()` pattern or add:
```javascript
createFloatTexture(width, height, internalFormat, label)
```

## Test Criteria

### Console Checks
- [ ] No WebGPU/WebGL errors when creating texture
- [ ] Log confirms: `"Transmittance LUT created: 256x64 RGBA16F"`
- [ ] Log shows texture handle is valid (not null)

### Functional
- [ ] AtmosphericScatteringLUT instantiates without errors
- [ ] Texture dimensions correct: 256×64
- [ ] Texture format is RGBA16Float/RGBA16F
- [ ] Both WebGPU and WebGL2 paths work
- [ ] Texture persists until dispose() called

### Performance
- [ ] Texture creation < 50ms
- [ ] No FPS drop after initialization
- [ ] Memory usage increase < 5MB

### Visual
- [ ] No rendering regression - terrain still renders correctly
- [ ] No black screens or artifacts

## Debug Commands
```javascript
window.testAtmosphereLUT = () => {
    console.log('LUT:', window.frontend.atmosphereLUT);
    console.log('Settings:', window.frontend.atmosphereSettings);
    console.log('Texture valid:', window.frontend.atmosphereLUT.transmittanceLUT !== null);
    console.log('Backend:', window.frontend.backend.api);
};
```

## Next Step
After passing all tests, proceed to: **2.2-transmittance-compute.md**