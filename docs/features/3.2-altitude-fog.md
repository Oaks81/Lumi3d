# 3.2: Altitude-Based Fog

## Dependencies
- 3.1: Aerial Perspective Integration ✓
- UniformManager (existing)
- Terrain shaders (existing)

## Scope
Replace old exponential fog (if it exists) with physically-based altitude-dependent fog. Fog density decreases exponentially with altitude, creating realistic atmospheric density near the surface.

## Current State
- Terrain shaders may have old fog implementation
- UniformManager can store fog parameters
- Backend packs/sets uniforms

## Architecture Integration
```
Frontend.render()
  └─> UniformManager.updateFogParams(camera.altitude, atmosphereSettings)
        ├─> Calculate fog density at current altitude
        ├─> Store in uniformManager
        └─> Backend packs into uniform buffer

Terrain Shader:
  ├─> Read fog density from uniforms
  ├─> Calculate altitude-based fog
  └─> Apply after aerial perspective
```

## What Needs to Happen

### 1. Remove Old Fog Code (if exists)

Search terrain shaders for old fog implementations:
```wgsl
// OLD - REMOVE THIS:
let fogFactor = exp(-distance * fogDensity);
finalColor = mix(fogColor, finalColor, fogFactor);
```

Replace with new altitude-based fog.

### 2. Add Fog Parameters to UniformManager

Add properties:
```javascript
this.fogParams = {
    density: 0.00005,        // At current altitude
    scaleHeight: 1200,       // Mie scale height
    color: { r: 0.7, g: 0.8, b: 1.0 }  // Sky-tinted
};
```

Add update method:
```javascript
updateFogParams(altitude, atmosphereSettings) {
    const surfaceDensity = 0.00005;
    const scaleHeight = atmosphereSettings.scaleHeightMie || 1200;
    
    // Density decreases exponentially with altitude
    this.fogParams.density = surfaceDensity * Math.exp(-altitude / scaleHeight);
    this.fogParams.scaleHeight = scaleHeight;
    
    // Fog color matches atmospheric scattering
    // (Could sample from aerial perspective color)
}
```

### 3. Pack Fog Uniforms in Backend

#### WebGPUBackend
Add to fragment uniforms (after atmospheric params):
```
fogDensity: f32
fogScaleHeight: f32
fogColor: vec3<f32>
padding: f32
```

Pack from `uniformManager.fogParams`.

#### WebGL2Backend
Set uniforms:
```javascript
gl.uniform1f(loc_fogDensity, uniformManager.fogParams.density);
gl.uniform1f(loc_fogScaleHeight, uniformManager.fogParams.scaleHeight);
gl.uniform3f(loc_fogColor, fogParams.color.r, fogParams.color.g, fogParams.color.b);
```

### 4. Update Shader Structs

#### WebGPU terrain.wgsl
```wgsl
struct FragmentUniforms {
    // ... existing fields ...
    
    fogDensity: f32,
    fogScaleHeight: f32,
    fogColor: vec3<f32>,
    _pad: f32,
}
```

#### WebGL2 terrain.glsl
```glsl
uniform float fogDensity;
uniform float fogScaleHeight;
uniform vec3 fogColor;
```

### 5. Implement Altitude Fog in Shader

Add function to terrain shader:
```wgsl
fn computeAltitudeFog(
    color: vec3<f32>,
    distance: f32,
    viewerAltitude: f32,
    targetAltitude: f32,
    fogDensity: f32,
    scaleHeight: f32,
    fogColor: vec3<f32>
) -> vec3<f32> {
    // Average altitude along ray
    let avgAltitude = (viewerAltitude + targetAltitude) * 0.5;
    
    // Density at average altitude
    let density = fogDensity * exp(-avgAltitude / scaleHeight);
    
    // Optical depth (Beer's law)
    let opticalDepth = density * distance;
    
    // Transmittance through fog
    let transmittance = exp(-opticalDepth);
    
    // Blend original color with fog color
    return mix(fogColor, color, transmittance);
}
```

Apply in fragment shader (after aerial perspective):
```wgsl
@fragment
fn fs_main(input: VertexOutput) -> @location(0) vec4<f32> {
    // ... existing shading + aerial perspective ...
    let atmosphericColor = applyAerialPerspective(...);
    
    // Apply altitude-based fog
    let distance = length(input.worldPos - uniforms.cameraPos);
    let finalColor = computeAltitudeFog(
        atmosphericColor,
        distance,
        uniforms.viewerAltitude,
        input.worldPos.z,  // Z is vertical
        uniforms.fogDensity,
        uniforms.fogScaleHeight,
        uniforms.fogColor
    );
    
    return vec4<f32>(finalColor, 1.0);
}
```

### 6. Update Frontend Render Loop

In `Frontend.render()`:
```javascript
// Update fog parameters based on camera altitude
this.uniformManager.updateFogParams(
    this.camera.position.z,
    this.atmosphereSettings
);
```

Call this before or alongside `updateAtmosphericParams()`.

## Algorithm Details

### Altitude-Based Density
```
density(h) = density₀ * exp(-h / H)
```

Where:
- `h` = altitude above surface
- `H` = scale height (1200m for Earth)
- `density₀` = density at sea level

### Optical Depth Approximation
For ray from altitude h₁ to h₂ at distance d:
```
opticalDepth ≈ density_avg * d
density_avg = density((h₁ + h₂) / 2)
```

This approximation works well for moderate distance changes.

### Transmittance
```
transmittance = exp(-opticalDepth)
```

### Final Blend
```
finalColor = lerp(fogColor, terrainColor, transmittance)
```

## Expected Behavior

At different altitudes:
- **0-500m:** Dense fog, visibility ~500m
- **1200m:** Moderate fog, visibility ~1500m (density = 36.8% of surface)
- **3600m:** Light fog, visibility ~10km (density = 5% of surface)
- **5000m+:** Minimal fog, clear view

## Files to Modify

- `js/rendering/UniformManager.js` - Add fog parameters and update method
- `js/rendering/backends/WebGPUBackend.js` - Pack fog uniforms
- `js/rendering/backends/WebGL2Backend.js` - Set fog uniforms
- `js/rendering/shaders/webgpu/terrain.wgsl` - Add altitude fog function
- `js/rendering/shaders/webgl2/terrain.glsl` - Add altitude fog function
- `js/rendering/Frontend.js` - Update fog params each frame

## Test Criteria

### Visual
- [ ] Low altitude (< 500m): Dense fog, limited visibility
- [ ] Mid altitude (1-3km): Moderate haze
- [ ] High altitude (> 5km): Clear view, minimal fog
- [ ] Fog blends naturally with aerial perspective
- [ ] Fog color matches sky/atmosphere

### Functional
- [ ] Old fog code removed/replaced
- [ ] New altitude-based fog integrated
- [ ] Fog density decreases exponentially with altitude
- [ ] At scaleHeight: density = 36.8% of surface
- [ ] At 3×scaleHeight: density = 5% of surface

### Console Checks
- [ ] Log fog density at different altitudes (optional)
- [ ] No shader compilation errors

### Performance
- [ ] No FPS impact (simple calculation)
- [ ] Fog computation < 0.05ms

## Debug Commands
```javascript
window.testAltitudeFog = () => {
    const altitudes = [0, 500, 1200, 2400, 3600, 5000];
    
    console.log('=== Altitude Fog Test ===');
    altitudes.forEach(alt => {
        window.camera.position.z = alt;
        window.gameEngine.render();
        
        const density = window.frontend.uniformManager.fogParams.density;
        const visibility = -Math.log(0.05) / density;
        
        console.log(`Alt: ${alt}m, Density: ${density.toExponential(2)}, Visibility: ${visibility.toFixed(0)}m`);
    });
};

window.toggleFog = () => {
    window.frontend.useFog = !window.frontend.useFog;
    console.log(`Fog: ${window.frontend.useFog}`);
};
```

## Common Issues

**Issue:** Fog too dense everywhere
- Reduce `surfaceDensity` constant (try 0.00002)
- Check altitude is being passed correctly
- Verify exp() calculation

**Issue:** Fog disappears too quickly
- Increase scale height to 2000m
- Check altitude values are reasonable
- Verify density calculation

**Issue:** Fog color doesn't match sky
- Use aerial perspective color for fog color
- Blend fog color with sun direction
- Sample atmospheric scattering color

**Issue:** Conflict with aerial perspective
- Ensure fog applied AFTER aerial perspective
- Consider merging both into single calculation
- Check order of operations in shader

## Integration Note

Altitude fog and aerial perspective are complementary:
- **Aerial perspective:** Long-distance scattering (> 1km)
- **Altitude fog:** Near-surface density (< 5km)

They can be unified into single scattering equation if desired, but separate is clearer.

## Next Step
After passing all tests, proceed to: **3.3-horizon-scattering.md**